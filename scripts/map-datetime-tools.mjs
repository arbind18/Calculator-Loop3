import fs from 'node:fs';
import path from 'node:path';

function read(file) {
  return fs.readFileSync(file, 'utf8');
}

function sliceBetween(text, startMarker, endMarker) {
  const start = text.indexOf(startMarker);
  if (start === -1) return '';
  const end = endMarker ? text.indexOf(endMarker, start + startMarker.length) : -1;
  return end === -1 ? text.slice(start) : text.slice(start, end);
}

function extractIdsFromToolsDataDatetime(toolsDataText) {
  const datetimeBlock = sliceBetween(toolsDataText, "datetime: {", "technology:");
  const ids = new Set();
  const re = /\{\s*id:\s*'([^']+)'/g;
  let m;
  while ((m = re.exec(datetimeBlock))) ids.add(m[1]);
  return Array.from(ids).sort();
}

function inArrayBlock(registryText, arrayName, id) {
  const block = sliceBetween(registryText, `const ${arrayName} = [`, `];`);
  return block.includes(`'${id}'`);
}

function hasExplicitMapping(registryText, id) {
  // crude but works: look for `'id': dynamic(`
  const re = new RegExp(`\\n\\s*'${id}'\\s*:\\s*dynamic\\(`);
  return re.test(registryText);
}

function classify(registryText, id) {
  const buckets = [];
  const arrays = [
    'genericDateTimeToolIds',
    'genericEverydayToolIds',
    'genericHealthToolIds',
    'genericMathToolIds',
    'genericPhysicsToolIds',
    'genericScientificToolIds',
    'genericTechnologyToolIds',
    'genericBusinessToolIds',
    'genericEducationToolIds',
    'genericConstructionToolIds',
  ];

  for (const name of arrays) {
    if (registryText.includes(`const ${name}`) && inArrayBlock(registryText, name, id)) {
      buckets.push(name);
    }
  }

  const explicit = hasExplicitMapping(registryText, id);
  return { buckets, explicit };
}

function toMarkdownTable(rows) {
  const header = ['Tool ID', 'In Generic Arrays', 'Explicit Mapping'];
  const lines = [];
  lines.push(`| ${header.join(' | ')} |`);
  lines.push(`| ${header.map(() => '---').join(' | ')} |`);
  for (const r of rows) {
    lines.push(`| ${r.id} | ${r.buckets.join(', ') || '-'} | ${r.explicit ? 'Yes' : 'No'} |`);
  }
  return lines.join('\n');
}

const root = process.cwd();
const toolsDataPath = path.join(root, 'src', 'lib', 'toolsData.ts');
const registryPath = path.join(root, 'src', 'lib', 'calculatorRegistry.ts');

const toolsDataText = read(toolsDataPath);
const registryText = read(registryPath);

const ids = extractIdsFromToolsDataDatetime(toolsDataText);

const rows = ids.map((id) => {
  const { buckets, explicit } = classify(registryText, id);
  return { id, buckets, explicit };
});

const out = [
  '# DateTime tools â†’ implementation map',
  '',
  `Total tools in toolsData.datetime: **${ids.length}**`,
  '',
  'This file is auto-generated by `scripts/map-datetime-tools.mjs`.',
  '',
  toMarkdownTable(rows),
  '',
].join('\n');

const outPath = path.join(root, 'datetime-tools-implementation-map.md');
fs.writeFileSync(outPath, out);
console.log(`Wrote ${outPath}`);
